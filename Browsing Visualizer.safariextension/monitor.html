<!DOCTYPE html>
<html>
<head>
<title>Monitor</title>
<script>
	console.log('Monitor Starting');

	//console.log(safari.application.activeBrowserWindow.tabs);

	var sessions = [];
	var lastNavigatedTo;
	var active;
	var activeStartTime = 0;
	var previousState;
	var links;

	var stateEnum = {
		OPEN: 0,
		CLOSE: 1,
		ACTIVE: 2,
		UNACTIVE: 3,
		PRE_NAVIGATION: 4,
		NAVIGATION: 5,
		PRE_SEARCH: 6
	};

	function printTabSessions() {
		for(var i = 0; i < sessions.length; ++i) {
			console.log(sessions[i]);
		}
	}

	function activateTimer(tab) {

	}

	function deactivateTimer(tab) {

	}

	function openHandler(openEvent) {
		console.log("Tab/Page Open");

		sessions.push({
			'tab': openEvent.target,
			'sessionStart': new Date(),
			'sessionDuration': 0,
			'parent': '',
			'children': []
		});

		console.log(sessions);
	}

	function closeHandler(closeEvent) {
		console.log("Tab/Page Open");
	}

	function activationHandler(activationEvent) {
		console.log("Tab/Page Activation");

		active = activationEvent.target;
	}

	function getSessionIndex(session) {
		for(var i = 0; i < sessions.length; i++) {
			if(sessions[i].tab == session) {
				return(i);
			}
		}
		return(false);
	}

	function deactivationHandler(deactivationEvent) {
		// subtract current tab start time from current time and add to total session duration
		var i = getSessionIndex(deactivationEvent.target);
		if(i) {
			sessions[i].sessionDuration += new Date() - sessions[i].sessionStart;
		}
	}

	function beforeNavigationHandler(beforeNavigationEvent) {
		console.log('Before Navigation');
	}

	function navigationHandler(navigationEvent) {
		console.log('Navigation');

		console.log(navigationEvent.target.url);
		if(links) {
			for(var i = 0; i < links.length; ++i) {
				if(links[i] == navigationEvent.target.url) {
					//sessions[getSessionIndex(active)].children.push(beforeNavigationEvent);
					console.log("WOOOOO!");
				}	
			}
		}

		safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("get_links");
	}

	function beforeSearchHandler(beforeSearchEvent) {
		console.log('Before Search');
		
	}

	function messageHandler(message) {
		links = message.message;
		console.log(links);
	}

	safari.application.addEventListener("message", messageHandler, false);
	safari.application.addEventListener("open", openHandler, true);
	safari.application.addEventListener("close", closeHandler, true);
	safari.application.addEventListener("activate", activationHandler, true);
	safari.application.addEventListener("deactivate", deactivationHandler, true);
	safari.application.addEventListener("navigate", navigationHandler, true);
	safari.application.addEventListener("beforeNavigate", beforeNavigationHandler, true);
	safari.application.addEventListener("beforeSearch", beforeSearchHandler, true);
</script>
</head>
<body>
	Monitor
</body>
</html>
