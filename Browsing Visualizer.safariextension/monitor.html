<!doctype html>
<html>
<head>
<title>Monitor</title>
<script>
	console.log('Monitor Starting');

	var sessions = [];
	var previouslyActive;
	var active;
  var currentlyNavigatedTo;
  var previoulsyNavigatedTo;
	var activeStartTime = 0;
	var previousState;
	var links;
  var nextNavigatedToIsChild = false;
  var previousIndex = null;
  var currentIndex = null;

	var stateEnum = {
		OPEN: 0,
		CLOSE: 1,
		ACTIVE: 2,
		UNACTIVE: 3,
		PRE_NAVIGATION: 4,
		NAVIGATION: 5,
		PRE_SEARCH: 6
	};

  function getRoot(index) {
    var i = index;
    while(sessions[i].parent != null) {
      i = sessions[i].parent;
    }
    return(i);
  }

	function getSessionIndex(session) {
		for(var i = 0; i < sessions.length; i++) {
			if(sessions[i].tab == session) {
				return(i);
			}
		}
		return(false);
	}

	function openHandler(openEvent) {
		console.log("Tab/Page Open");

    // when new tab or window is opened push parent object
		sessions.push({
			'tab': openEvent.target,
      'url': openEvent.target.url,
			'sessionStart': new Date(),
			'sessionDuration': 0,
			'parent': null,
			'children': []
		});

    currentIndex = sessions.length - 1;
	}

	function closeHandler(closeEvent) {
		console.log("Tab/Page Open");

    if(currentIndex != null) {
      sessions[currentIndex].sessionDuration += new Date() - sessions[currentIndex].sessionStart;
    }
	}

	function activationHandler(activationEvent) {
		console.log("Tab/Page Activation");

    previouslyActive = active;
		active = activationEvent.target;
	}

	function deactivationHandler(deactivationEvent) {
    //sessions[currentIndex].sessionDuration += new Date() - sessions[i].sessionStart;
	}

	function beforeNavigationHandler(beforeNavigationEvent) {
		console.log('Before Navigation');

    previouslyNavigatedTo = beforeNavigationEvent.target;
	}

	function navigationHandler(navigationEvent) {
		console.log('Navigation');
		
    if(nextNavigatedToIsChild) {
      // calculate session duration
      sessions[currentIndex].sessionDuration += new Date() - sessions[currentIndex].sessionStart;
      // create new session with parent set
      sessions.push({
        'tab': navigationEvent.target,
        'url': navigationEvent.target.url,
        'sessionStart': new Date(),
        'sessionDuration': 0,
        'parent': currentIndex,
        'children': []
      });
      previousIndex = currentIndex;
      currentIndex = sessions.length - 1;
      // push child index onto parent child array
      sessions[previousIndex].children.push(currentIndex);
      // reset flag
      nextNavigatedToIsChild = false;
    }

    console.log(sessions);
	}

	function beforeSearchHandler(beforeSearchEvent) {
		console.log('Before Search');

    sessions[currentIndex].sessionDuration += new Date() - sessions[currentIndex].sessionStart;
    var rootIndex = getRoot(currentIndex);

    sessions.push({
      'tab': beforeSearchEvent.target,
      'url': beforeSearchEvent.target.url,
      'sessionStart': new Date(),
      'sessionDuration': 0,
      'parent': rootIndex,
      'children': []
    });

    previousIndex = rootIndex;
    currentIndex = sessions.length - 1;
	}

	function messageHandler(message) {
    if(message.name == 'child_link_followed') {
      nextNavigatedToIsChild = true;
    }
	}

	safari.application.addEventListener("message", messageHandler, false);
	safari.application.addEventListener("open", openHandler, true);
	safari.application.addEventListener("close", closeHandler, true);
	safari.application.addEventListener("activate", activationHandler, true);
	safari.application.addEventListener("deactivate", deactivationHandler, true);
	safari.application.addEventListener("navigate", navigationHandler, true);
	safari.application.addEventListener("beforeNavigate", beforeNavigationHandler, true);
	safari.application.addEventListener("beforeSearch", beforeSearchHandler, true);
</script>
</head>
<body>
	Monitor
</body>
</html>
